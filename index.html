<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gram Panchayat Survey Mubarakpur Kalan</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f8f9fa; margin:0; padding:20px; }
    h1 { text-align:center; color:#2c3e50; }
    .candidate { margin:10px 0; padding:10px; background:#fff; border:1px solid #ddd; border-radius:8px; }
    button { background:#3498db; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; }
    button:disabled { background:#aaa; cursor:not-allowed; }
    #result { margin-top:20px; }
    #timer { text-align:center; font-weight:bold; margin:15px 0; color:#e74c3c; font-size:18px; }
    footer { text-align:center; margin-top:40px; font-size:14px; color:#555; }
  </style>
</head>
<body>

<h1>Gram Panchayat Survey - Mubarakpur Kalan</h1>
<p style="text-align:center;">⚠️ Yeh ek demo survey hai, asli chunav voting nahi.</p>

<div id="timer"></div>

<div id="candidates"></div>

<div style="text-align:center; margin-top:20px;">
  <button onclick="showResults()">Result Dekho</button>
</div>

<div id="result"></div>

<footer>
  <p>Ye survey <strong>20 November  2025</strong> ko khatam ho jayega</p>
  <p>Contact: <a href="mailto:divisorindustries@gmail.com">divisorindustries@gmail.com</a></p>
  <p>Powered by Divisor Studios</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ✅ Supabase config
  const SUPABASE_URL = "https://rmkcfvpbdhstmbxemzyx.supabase.co"; // tumhara project ref
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJta2NmdnBiZGhzdG1ieGVtenl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDI5NjUsImV4cCI6MjA3NDcxODk2NX0.IzNvx_UuKIBdhgFLTiQHhxwMus4cGHL1ED2Z-U9z0rk";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ✅ Candidate list
  const candidates = [
    "Sabeel",
    "Aaftab",
    "Asad",  
    "Others",
  ];

  // ✅ Survey end date (fixed)
  const surveyEnd = new Date("2025-11-20T23:59:59");

  const container = document.getElementById("candidates");
  const timerDiv = document.getElementById("timer");

  // Countdown Timer
  function updateTimer() {
    const now = new Date();
    const diff = surveyEnd - now;

    if (diff <= 0) {
      timerDiv.innerHTML = "⏰ Survey khatam ho gaya!";
      container.innerHTML = "<p style='color:red; font-weight:bold;'>Voting band ho gayi hai. Sirf result dekh sakte ho.</p>";
      return;
    }

    let days = Math.floor(diff / (1000 * 60 * 60 * 24));
    let hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
    let minutes = Math.floor((diff / (1000 * 60)) % 60);
    let seconds = Math.floor((diff / 1000) % 60);

    timerDiv.innerHTML = `Survey khatam hone me: ${days}d ${hours}h ${minutes}m ${seconds}s`;
  }

  setInterval(updateTimer, 1000);
  updateTimer();

  // Render candidates
  async function renderCandidates(disabled=false) {
    container.innerHTML = '';
    candidates.forEach(name => {
      let div = document.createElement("div");
      div.className = "candidate";
      let btn = document.createElement("button");
      btn.innerText = "Vote " + name;
      btn.disabled = disabled;
      btn.onclick = async () => {
        await handleVote(name);
      };
      div.innerHTML = `<strong>${name}</strong><br>`;
      div.appendChild(btn);
      container.appendChild(div);
    });
  }

  // Handle vote → insert into Supabase (with 1 IP restriction)
async function handleVote(option) {
  try {
    // Get user IP
    let res = await fetch("https://api64.ipify.org?format=json");
    let ipData = await res.json();
    let userIp = ipData.ip;

    // Try to insert vote with IP
    const { error } = await supabase.from('votes').insert([{ option, ip_address: userIp }]);

    if (error) {
      if (error.code === '23505') {
        alert("⚠️ Aap is device/IP se pehle hi vote kar chuke ho!");
      } else {
        alert("Vote save karne me error aaya.");
        console.error(error);
      }
    } else {
      alert("✅ Aapne " + option + " ko vote diya.");
    }
  } catch (e) {
    console.error("IP fetch error:", e);
    alert("IP address fetch karne me dikkat aayi.");
  }
}
  // Show results from Supabase
  async function showResults() {
    let resultDiv = document.getElementById("result");
    resultDiv.innerHTML = "<h2>Survey Results</h2>";

    const { data, error } = await supabase.from('votes').select('option');
    if (error) {
      resultDiv.innerHTML += "<p>Error results fetch karne me.</p>";
      return;
    }

    let counts = {};
    data.forEach(v => { counts[v.option] = (counts[v.option]||0)+1 });
    let total = data.length;
    if (total === 0) {
      resultDiv.innerHTML += "<p>Abhi tak koi vote nahi aaya.</p>";
      return;
    }
    candidates.forEach(name => {
      let count = counts[name] || 0;
      let percent = ((count / total) * 100).toFixed(1);
      resultDiv.innerHTML += `<p>${name}: ${count} votes (${percent}%)</p>`;
      resultDiv.innerHTML += `<div style=\"background:#ddd; border-radius:5px; margin-bottom:5px;\">\n        <div style=\"width:${percent}%; background:#3498db; color:white; padding:3px; border-radius:5px;\">${percent}%</div>\n      </div>`;
    });
  }

  renderCandidates();

  // Supabase realtime subscription for live updates
  supabase
    .channel('custom-all-channel')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'votes' }, payload => {
      showResults();
    })
    .subscribe();

</script>

</body>
</html>
